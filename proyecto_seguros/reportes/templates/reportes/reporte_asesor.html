{% extends "dashboard_admin/dashboard_base.html" %}
{% load humanize %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Reporte de Rendimiento por Asesor</h1>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <form method="get">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <select name="asesor_id" class="form-select" required>
                        <option value="">Selecciona un asesor...</option>
                        {% for asesor in asesores %}
                        <option value="{{ asesor.pk }}" {% if asesor_seleccionado.pk == asesor.pk %}selected{% endif %}>
                            {{ asesor.nombre_completo }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="mes" class="form-select">
                        {% for num, nombre in meses %}
                        <option value="{{ num }}" {% if num == mes_seleccionado %}selected{% endif %}>{{ nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="ano" class="form-select">
                        {% for ano in rango_anos %}
                        <option value="{{ ano }}" {% if ano == ano_seleccionado %}selected{% endif %}>{{ ano }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-primary-assecol">Generar Reporte</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if asesor_seleccionado %}
<h3 class="mb-3">Resultados para: <span class="text-primary">{{ asesor_seleccionado.nombre_completo }}</span></h3>
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="stat-card">
            <p class="text-secondary text-uppercase">Pólizas Vendidas (Mes)</p>
            <h1>{{ polizas_vendidas.count }}</h1>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="stat-card">
            <p class="text-secondary text-uppercase">Total Primas (sin IVA)</p>
            <h1>${{ total_primas_vendidas|floatformat:0|intcomma }}</h1>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="stat-card">
            <p class="text-secondary text-uppercase">Total Comisiones Generadas</p>
            <h1>${{ total_comisiones_generadas|floatformat:0|intcomma }}</h1>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-light">
        <h5 class="mb-0">Detalle de Ventas</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr><th># Póliza</th><th>Cliente</th><th>Tipo de Seguro</th><th>Compañía</th><th>Prima (sin IVA)</th><th>Comisión</th></tr>
                </thead>
                <tbody>
                    {% for poliza in polizas_vendidas %}
                    <tr>
                        <td>{{ poliza.numero_poliza }}</td>
                        <td>{{ poliza.cliente.get_full_name }}</td>
                        <td>{{ poliza.tipo_seguro.nombre }}</td>
                        <td>{{ poliza.compania_aseguradora.nombre }}</td>
                        <td>${{ poliza.valor_prima_sin_iva|floatformat:0|intcomma }}</td>
                        <td class="fw-bold">${{ poliza.valor_comision|floatformat:0|intcomma }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">Selecciona un asesor y un periodo para generar el reporte.</div>
{% endif %}
{% endblock %}