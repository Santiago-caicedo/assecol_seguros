{% extends "dashboard_admin/dashboard_base.html" %}
{% load humanize %}

{% block dashboard_content %}
<h1 class="h2 mb-4">Cancelar Póliza #{{ poliza.numero_poliza }}</h1>

<div class="card shadow-sm border-0">
    <div class="card-body p-4">

        <p>Estás a punto de cancelar la póliza de <strong>{{ poliza.tipo_seguro.nombre }}</strong> para el cliente <strong>{{ poliza.cliente.get_full_name }}</strong>.</p>

        {% if poliza.modo_pago == 'CONTADO' %}
            <div class="alert alert-warning">
                <h5 class="alert-heading">Cálculo de Devolución (Prorrateo)</h5>
                <p>Esta póliza fue pagada de contado. Al confirmar la cancelación, se registrarán los siguientes valores:</p>
                <hr>
                <div class="d-flex justify-content-between">
                    <strong>Monto a devolver al cliente:</strong>
                    <strong class="text-success fs-5">${{ devolucion_calculada|intcomma }}</strong>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <strong>Comisión a retornar por Assecol:</strong>
                    <strong class="text-danger fs-5">${{ comision_devuelta_calculada|intcomma }}</strong>
                </div>
            </div>
        {% endif %}

        <p class="text-danger">Esta acción cambiará el estado de la póliza a "CANCELADA".</p>

        {# 👇 FORMULARIO AÑADIDO (ESTO FALTABA) 👇 #}
        <form method="post" class="mt-4">
            {% csrf_token %}
            <div class="mb-3">
                <label for="{{ form.motivo_cancelacion.id_for_label }}" class="form-label fw-bold">Motivo de la Cancelación (Requerido)</label>
                {{ form.motivo_cancelacion }}
                {% if form.motivo_cancelacion.errors %}<div class="text-danger small mt-1">{{ form.motivo_cancelacion.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mt-4 text-end">
                <a href="{% url 'dashboard_admin:lista_polizas_cliente' pk=poliza.cliente.pk %}" class="btn btn-secondary">Volver</a>
                <button type="submit" class="btn btn-danger">Confirmar Cancelación</button>
            </div>
        </form>

    </div>
</div>
{% endblock %}