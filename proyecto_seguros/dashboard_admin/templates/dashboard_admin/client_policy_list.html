{% extends "dashboard_admin/dashboard_base.html" %}
{% load humanize %}

{% block dashboard_content %}
{# Encabezado y botón para volver #}
<div class="d-flex justify-content-between align-items-center mb-4">
    <a href="{% url 'dashboard_admin:lista_clientes' %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-2"></i>Volver a Clientes
    </a>
</div>

{# Tarjeta con la información del cliente #}
<div class="card shadow-sm mb-4">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">{{ cliente.get_full_name|default:cliente.username }}</h2>
                <p class="text-muted mb-0">{{ cliente.email }} | Tel: {{ cliente.perfilcliente.telefono|default:'N/A' }}</p>
            </div>
            <div>
                <a href="{% url 'dashboard_admin:editar_cliente' pk=cliente.pk %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-edit me-1"></i> Editar Cliente
                </a>
            </div>
        </div>
    </div>
</div>

{# Sección de Pólizas #}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Pólizas del Cliente ({{ polizas.count }})</h4>
    <a href="{% url 'dashboard_admin:crear_poliza_cliente' pk=cliente.pk %}" class="btn btn-primary-assecol">Añadir Nueva Póliza</a>
</div>

<div class="row">
    {% for poliza in polizas %}
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                {# Encabezado de la póliza #}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="fw-bold text-primary">{{ poliza.tipo_seguro.nombre }}</div>
                    {# Lógica de la insignia de estado actualizada #}
                {% if poliza.estado == 'CANCELADA' and poliza.monto_devolucion %}
                <div class="alert alert-secondary text-center small p-2 mt-3">
                    Devolución al cliente: <strong>${{ poliza.monto_devolucion|intcomma }}</strong>
                </div>
                {% endif %}
                {% if poliza.estado == 'ACTIVA' %}
                    <span class="badge rounded-pill text-bg-success">Activa</span>
                {% elif poliza.estado == 'CANCELADA' %}
                    <span class="badge rounded-pill text-bg-secondary">Cancelada</span>
                {% elif poliza.estado == 'VENCIDA' %}
                    <span class="badge rounded-pill text-bg-danger">Vencida</span>
                {% endif %}
                </div>
                <p class="text-muted small">Póliza #{{ poliza.numero_poliza }}</p>
                <hr>
                {# Fechas #}
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="small text-muted mb-0">FECHA DE INICIO</p>
                        <p class="fw-bold mb-0">{{ poliza.fecha_inicio|date:"d M, Y" }}</p>
                    </div>
                    <div class="text-end">
                        <p class="small text-muted mb-0">FECHA DE VENCIMIENTO</p>
                        <p class="fw-bold mb-0">{{ poliza.fecha_fin|date:"d M, Y" }}</p>
                    </div>
                </div>
                <hr>
                {# Documentos y Acciones #}
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if poliza.poliza_pdf %}
                        <a href="{{ poliza.poliza_pdf.url }}" target="_blank">
                            <i class="fas fa-file-pdf text-danger"></i>
                            poliza_{{ poliza.numero_poliza }}.pdf
                        </a>
                        {% else %}
                            <span class="text-muted small">Sin documento</span>
                        {% endif %}
                    </div>
                    <div>
                        {# Solo mostramos el botón de Cancelar si la póliza está ACTIVA #}
                        {% if poliza.estado == 'ACTIVA' %}
                            <a href="{% url 'dashboard_admin:cancelar_poliza' pk=poliza.pk %}" class="btn btn-outline-danger btn-sm">Cancelar</a>
                        {% endif %}
                        <a href="{% url 'dashboard_admin:editar_poliza' pk=poliza.pk %}" class="btn btn-outline-secondary btn-sm">Editar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col">
        <div class="alert alert-info">Este cliente no tiene pólizas registradas.</div>
    </div>
    {% endfor %}
</div>

{% endblock %}